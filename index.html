<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Anus Words v. Subs</title>
<style>
/* --- General Text Styling --- */
body, input, button, select, textarea, div, span, li {
    font-family: "MS Sans Serif", Tahoma, sans-serif;
}

/* Body */
body {
  background: #008080;
  color: black;
  margin: 0;
  padding-bottom: 40px;
  text-align: center;
  overflow-x: hidden;
}

/* Start bar */
#startBar {
  position: fixed; bottom: 0; left: 0; width: 100%; height: 40px;
  background: #c0c0c0; border-top: 2px solid #fff inset; border-bottom: 2px solid #000 outset;
  display: flex; align-items: center; justify-content: space-between; padding: 0 5px;
}
#startBar button {
  font-weight: bold; padding: 4px 10px; border: 2px outset #fff; background: #c0c0c0; cursor: pointer;
}
#clock { font-size: 12px; font-weight: bold; }

/* Draggable dialog windows */
.window, #subscriberBox, #timerBox {
  border: 2px solid #000; box-shadow: 4px 4px #808080; background: #c0c0c0; position: absolute;
  touch-action: none;
  min-width: 150px;
}
.window { width: 600px; max-width: 90%; top: 60px; left: 50%; transform: translateX(-50%); }
.title-bar {
  background: #000080; color: white; padding: 3px 5px; font-weight: bold; font-size: 14px;
  display: flex; justify-content: space-between; align-items: center;
  cursor: move;
}
.title-bar button {
  width: 20px; height: 18px; font-weight: bold;
  border: 2px outset #fff; background: #c0c0c0; cursor: pointer;
}
.content { padding: 10px; background: #c0c0c0; }

/* Input and list styling */
input#wordInput { padding: 4px; font-size: 14px; width: 100%; max-width: 580px; border: 2px inset #fff; box-sizing: border-box; }
#counter { margin: 10px 0; font-weight: bold; font-size: 16px; }
#message { color: red; font-weight: bold; margin-top: 5px; }
#wordList { max-height: 250px; overflow-y: auto; background: #fff; border: 2px inset #fff; margin-top: 10px; padding: 5px; list-style: none; }
li { border-bottom: 1px solid #808080; padding: 2px; }

/* Progress bar (brown) */
.progress-container { 
  background: #c0c0c0; border: 2px inset #fff; width: 100%; height: 20px; margin-top: 10px; position: relative; 
}
.progress-bar { 
  background: #8B4513; height: 100%; width: 0%; position: relative; 
}
.progress-bar span { 
  position: absolute; width: 100%; text-align: center; font-weight: bold; color: black; 
}

/* Subscriber tracker */
#subscriberBox { width: 200px; z-index:10; top: 10px; right: 10px; }
#subscriberBox .content { display: flex; flex-direction:column; align-items: center; gap: 5px; justify-content: center; font-size: 14px; padding: 5px; }
#subscriberBox svg { cursor:pointer; }

/* Timer window */
#timerBox { width: 200px; z-index: 10; top: 10px; left: 10px; }
#timerBox .content { padding:5px; display:flex; flex-direction:column; gap:5px; align-items:center; font-size:14px; }
#timerBox .buttons-row { display:flex; gap:5px; justify-content:center; }

/* Minimized boxes container */
#minimizedContainer { position: fixed; bottom: 40px; left: 0; display: flex; gap: 5px; padding: 5px; }
.minimized-btn { border: 2px outset #fff; background: #c0c0c0; cursor: pointer; padding: 2px 6px; font-size:12px; }

@media(max-width:700px){
  .window,#subscriberBox,#timerBox{width:90%; left:5% !important; transform:none;}
}
</style>
</head>
<body>

<!-- Minimized container -->
<div id="minimizedContainer"></div>

<!-- Subscriber tracker -->
<div id="subscriberBox">
  <div class="title-bar">
    <span>Subscribers</span>
    <div>
      <button class="minimizeBtn">_</button>
      <button onclick="window.open('https://www.youtube.com/@ANewUntoldStory','_blank')">X</button>
    </div>
  </div>
  <div class="content">
    <!-- Inline SVG YouTube logo -->
    <svg id="ytLogo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" width="24" height="24" style="fill:red;">
      <path d="M549.655 124.083c-6.281-23.651-24.813-42.192-48.461-48.461C459.79 64 288 64 288 64S116.21 64 74.805 75.622c-23.648 6.269-42.18 24.81-48.461 48.461C16 165.487 16 256 16 256s0 90.513 10.344 131.917c6.281 23.651 24.813 42.192 48.461 48.461C116.21 448 288 448 288 448s171.79 0 213.195-11.622c23.648-6.269 42.18-24.81 48.461-48.461C560 346.513 560 256 560 256s0-90.513-10.345-131.917zM232 336V176l142 80-142 80z"/>
    </svg>
    <span id="subscriberCount">Loading...</span>
    <div class="progress-container">
      <div id="progressBar" class="progress-bar">
        <span id="progressText"></span>
      </div>
    </div>
  </div>
</div>

<!-- Timer -->
<div id="timerBox">
  <div class="title-bar">
    <span>Timer</span>
    <div>
      <button class="minimizeBtn">_</button>
      <button onclick="timerBox.style.display='none'">X</button>
    </div>
  </div>
  <div class="content">
    <div>Time: <span id="elapsed">00:00.00</span></div>
    <div>ETA: <span id="eta">0d 0h 0m</span></div>
    <div class="buttons-row">
      <button id="startBtn">Start</button>
      <button id="pauseBtn">Pause</button>
      <button id="resetBtn">Reset</button>
    </div>
  </div>
</div>

<!-- Import/Export Window -->
<div id="importExportBox" class="window" style="width:420px; top:120px; left:65%; transform:translateX(-50%); z-index:12;">
  <div class="title-bar">
    <span>Import / Export</span>
    <div>
      <button class="minimizeBtn">_</button>
      <button onclick="importExportBox.style.display='none'">X</button>
    </div>
  </div>
  <div class="content">
    <div style="display:flex;flex-direction:column;gap:8px;align-items:center;">
      <div style="width:100%;text-align:left;font-weight:bold;">Export</div>
      <div style="width:100%;display:flex;gap:8px;justify-content:center;">
        <button id="exportBtn">Export to Excel</button>
      </div>

      <hr style="width:100%;border:1px dashed #808080;" />

      <div style="width:100%;text-align:left;font-weight:bold;">Import</div>
      <div style="width:100%;display:flex;gap:8px;flex-direction:column;align-items:center;">
        <input id="fileInput" type="file" accept=".xlsx,.xls" style="display:none" />
        <button id="chooseFileBtn">Choose Excel File</button>
        <div id="fileName" style="font-size:12px;color:#000"></div>

        <!-- After file is parsed, show options -->
        <div id="importConfirm" style="display:none;width:100%;gap:6px;align-items:center;">
          <div id="importSummary" style="font-size:13px;margin-bottom:6px;"></div>
          <div style="display:flex;gap:6px;justify-content:center;">
            <button id="replaceBtn">Replace All with File</button>
            <button id="appendBtn">Append New Words</button>
            <button id="cancelImportBtn">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Main words window -->
<div class="window" style="z-index:11;">
  <div class="title-bar">
    <span>Anus Words v. Subs</span>
    <div>
      <button class="minimizeBtn">_</button>
      <button id="clearWordsBtn">X</button>
    </div>
  </div>
  <div class="content">
    <input id="wordInput" type="text" placeholder="Enter a word..." />
    <div id="counter">0 / 0</div>
    <div id="message"></div>
    <ul id="wordList"></ul>
  </div>
</div>

<!-- Start bar -->
<div id="startBar">
  <button id="bottomStartBtn">Start</button>
  <div id="clock"></div>
</div>

<!-- SheetJS (XLSX) for Excel read/write -->
<script src="https://cdn.sheetjs.com/xlsx-0.19.1/package/dist/xlsx.full.min.js"></script>

<script type="module">
/* =======================
   Firebase + App Logic
   ======================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDocs, collection, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// Firebase setup
const firebaseConfig = {
  apiKey: "AIzaSyC8Z5Lx8W8RHYhsIGOb-yLVsv5Ufv50ULM",
  authDomain: "anus-words.firebaseapp.com",
  projectId: "anus-words",
  storageBucket: "anus-words.firebasestorage.app",
  messagingSenderId: "15328801675",
  appId: "1:15328801675:web:4b52ea27902c27fcfeb58e",
  measurementId: "G-MY6LCMKMX5"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const wordsCollection = collection(db,"words");

/* DOM elements */
const input=document.getElementById("wordInput");
const list=document.getElementById("wordList");
const counter=document.getElementById("counter");
const message=document.getElementById("message");
const subscriberCountDiv=document.getElementById("subscriberCount");
const progressBar=document.getElementById("progressBar");
const progressText=document.getElementById("progressText");
const clearWordsBtn=document.getElementById("clearWordsBtn");
const startBtn=document.getElementById("startBtn");
const pauseBtn=document.getElementById("pauseBtn");
const resetBtn=document.getElementById("resetBtn");
const bottomStartBtn=document.getElementById("bottomStartBtn");
const elapsedSpan=document.getElementById("elapsed");
const etaSpan=document.getElementById("eta");
const timerBox=document.getElementById("timerBox");
const minimizedContainer=document.getElementById("minimizedContainer");

const importExportBox = document.getElementById('importExportBox');
const exportBtn = document.getElementById('exportBtn');
const chooseFileBtn = document.getElementById('chooseFileBtn');
const fileInput = document.getElementById('fileInput');
const fileNameDiv = document.getElementById('fileName');
const importConfirm = document.getElementById('importConfirm');
const importSummary = document.getElementById('importSummary');
const replaceBtn = document.getElementById('replaceBtn');
const appendBtn = document.getElementById('appendBtn');
const cancelImportBtn = document.getElementById('cancelImportBtn');

let words=new Set(), subscriberCount=0, timer=null, elapsed=0, running=false;

/* ---------- Clock ---------- */
function updateClock(){ 
  const now=new Date(); 
  let h=now.getHours(); 
  const ampm=h>=12?"PM":"AM"; 
  h=h%12||12; 
  const m=String(now.getMinutes()).padStart(2,'0'); 
  const s=String(now.getSeconds()).padStart(2,'0'); 
  document.getElementById("clock").textContent=`${h}:${m}:${s} ${ampm}`;
}
setInterval(updateClock,1000); updateClock();

/* ---------- Timer ---------- */
function updateTimerDisplay(){ 
  // mm:ss.ss format
  const minutes = Math.floor(elapsed/60);
  const seconds = (elapsed % 60).toFixed(2);
  elapsedSpan.textContent = `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(5,'0')}`;

  // ETA calculation
  const wpm = elapsed>0 ? (words.size/(elapsed/60)) : 0;
  const etaSecs = wpm>0 ? (subscriberCount-words.size)/wpm*60 : 0; 
  const d=Math.floor(etaSecs/86400), h=Math.floor((etaSecs%86400)/3600), m=Math.floor((etaSecs%3600)/60); 
  etaSpan.textContent=`${d}d ${h}h ${m}m`; 
}

startBtn.onclick=function(){ if(!running){ running=true; timer=setInterval(()=>{elapsed+=0.1; updateTimerDisplay();},100); }}
pauseBtn.onclick=function(){ if(running){ clearInterval(timer); running=false; }}
resetBtn.onclick=function(){ clearInterval(timer); elapsed=0; running=false; updateTimerDisplay(); }

/* Bottom Start button */
bottomStartBtn.onclick=function(){ alert("Fuck No Baby!"); }

/* ---------- Firestore: Fetch words ---------- */
async function fetchWords(){ 
  words.clear(); 
  try{
    const snapshot=await getDocs(wordsCollection); 
    snapshot.forEach(docSnap=>words.add(docSnap.id.toLowerCase())); 
  }catch(e){
    console.error('Error fetching words', e);
  }
  updateDisplay(); updateTimerDisplay(); 
}

/* ---------- Add word ---------- */
async function addWord(){ 
  const newWord=input.value.trim().toLowerCase(); 
  message.textContent=""; 
  if(!newWord) return; 
  if(words.has(newWord)){message.textContent="Duplicate!";} 
  else { 
    try{
      await setDoc(doc(db,"words",newWord),{createdAt:serverTimestamp()});
      words.add(newWord); updateDisplay(); updateTimerDisplay();
    } catch(e){
      console.error(e); message.textContent="Error adding word.";
    } 
  } 
  input.value=""; input.focus(); 
}
input.addEventListener("keypress",function(e){if(e.key==="Enter") addWord();});

/* ---------- Clear words (protected by simple prompt) ---------- */
clearWordsBtn.addEventListener("click", async()=>{ 
  const password=prompt("Password:"); 
  if(password!=="anuspass"){alert("Incorrect password."); return;} 
  try{
    const snapshot=await getDocs(wordsCollection); 
    const batch=writeBatch(db); 
    snapshot.forEach(docSnap=>batch.delete(docSnap.ref)); 
    await batch.commit(); words.clear(); updateDisplay(); updateTimerDisplay(); alert("All words cleared!");
  }catch(e){
    console.error('Error clearing words', e);
    alert('Error clearing words. See console.');
  }
});

/* ---------- Update display & progress ---------- */
function updateDisplay(){
  counter.textContent=`${words.size.toLocaleString()} / ${subscriberCount.toLocaleString()}`;
  list.innerHTML="";
  // reverse display
  [...words].reverse().forEach(word=>{ const li=document.createElement("li"); li.textContent=word; list.appendChild(li); });

  const progress = subscriberCount>0? Math.min(words.size/subscriberCount,1):0;
  progressBar.style.width = (progress*100).toFixed(2) + "%";
  progressText.textContent = (progress*100).toFixed(2) + "%";
}

/* ---------- Fetch subscribers (YouTube API) ---------- */
async function fetchSubscribers(){ 
    const apiKey="AIzaSyBtcKxmge24wcaEQwJv0uBHKmQBLgIg0gw"; 
    const channelId="UCL6OtB3m-gQ2mgRg61-aDXw"; 
    try{ 
        const res=await fetch(`https://www.googleapis.com/youtube/v3/channels?part=statistics&id=${channelId}&key=${apiKey}`); 
        const data=await res.json(); 
        if(data.items && data.items.length>0){ 
            subscriberCount = parseInt(data.items[0].statistics.subscriberCount); 
            subscriberCountDiv.textContent = subscriberCount.toLocaleString(); 
            updateDisplay(); 
        } else subscriberCountDiv.textContent="Subscriber data not found."; 
    } catch(e){ 
        subscriberCountDiv.textContent="Error loading subscribers."; 
        console.error(e); 
    }
}

/* Initialize */
fetchWords(); fetchSubscribers(); setInterval(fetchSubscribers,30000);

/* YouTube logo click */
document.getElementById("ytLogo").addEventListener("click",()=>{ window.open("https://www.youtube.com/@ANewUntoldStory","_blank"); });

/* ---------- Draggable & Minimize ---------- */
function makeDraggable(el){
  const title=el.querySelector('.title-bar');
  let offsetX=0, offsetY=0, isDown=false;
  title.addEventListener('mousedown', e=>{isDown=true; offsetX=e.clientX-el.offsetLeft; offsetY=e.clientY-el.offsetTop;});
  document.addEventListener('mousemove', e=>{if(!isDown) return; let x=e.clientX-offsetX, y=e.clientY-offsetY; x=Math.max(0,Math.min(window.innerWidth-el.offsetWidth,x)); y=Math.max(0,Math.min(window.innerHeight-el.offsetHeight,y)); el.style.left=x+'px'; el.style.top=y+'px';});
  document.addEventListener('mouseup', ()=>{isDown=false;});
}
document.querySelectorAll('.window, #subscriberBox, #timerBox').forEach(makeDraggable);

/* Minimize buttons */
document.querySelectorAll('.minimizeBtn').forEach(btn=>{
  btn.addEventListener('click', e=>{
    const win=btn.closest('.window, #subscriberBox, #timerBox');
    win.style.display='none';
    const minimized=document.createElement('button');
    minimized.className='minimized-btn';
    minimized.textContent=win.querySelector('.title-bar span').textContent;
    minimized.onclick=()=>{ win.style.display='block'; minimized.remove(); };
    minimizedContainer.appendChild(minimized);
  });
});

/* Mobile repositioning */
function repositionBoxes(){
  const boxes=[...document.querySelectorAll('.window, #subscriberBox, #timerBox')].filter(b=>b.style.display!=='none');
  let topOffset=10;
  boxes.forEach(b=>{
    if(window.innerWidth<700){
      b.style.top=topOffset+'px';
      b.style.left='5%';
      b.style.transform='none';
      topOffset+=b.offsetHeight+10;
    }
  });
}
window.addEventListener('resize', repositionBoxes);
repositionBoxes();

/* =========================
   Import / Export (SheetJS)
   ========================= */

/* Export current words set to Excel */
exportBtn.addEventListener('click', () => {
  // Convert Set to array and build worksheet
  const arr = [...words].map(w => ({Word: w}));
  const ws = XLSX.utils.json_to_sheet(arr);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Words');
  // Trigger download with a timestamped filename
  const fname = `anus-words-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.xlsx`;
  XLSX.writeFile(wb, fname);
});

/* Choose file */
chooseFileBtn.addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', async (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  fileNameDiv.textContent = file.name;
  try{
    const data = await file.arrayBuffer();
    const workbook = XLSX.read(data, {type:'array'});
    const firstSheetName = workbook.SheetNames[0];
    const ws = workbook.Sheets[firstSheetName];
    const json = XLSX.utils.sheet_to_json(ws, {header:1, defval:''});
    // Extract first column as words, ignoring empty rows and header-like values
    const parsed = [];
    for(let i=0;i<json.length;i++){
      const row = json[i];
      if(!row || row.length===0) continue;
      const cell = String(row[0]||'').trim();
      if(cell) parsed.push(cell.toLowerCase());
    }
    // Deduplicate parsed array
    const parsedSet = new Set(parsed);
    // Prepare summary and show confirm UI (user requested confirm after upload)
    importSummary.textContent = `${parsedSet.size.toLocaleString()} unique words found in file.`;
    importConfirm.style.display='flex';
    // Temporarily store parsed values on the element for later actions
    importConfirm._parsed = parsedSet;
  }catch(err){
    alert('Error reading file. Make sure it is a valid Excel file.');
    console.error(err);
  }
});

/* Cancel import */
cancelImportBtn.addEventListener('click', ()=>{
  fileInput.value=''; fileNameDiv.textContent=''; importConfirm.style.display='none'; importConfirm._parsed=null;
});

/* Replace all words in Firestore with the uploaded file's words */
replaceBtn.addEventListener('click', async ()=>{
  const parsedSet = importConfirm._parsed; if(!parsedSet) return;
  if(!confirm(`Are you sure you want to REPLACE all existing words (${words.size.toLocaleString()}) with the ${parsedSet.size.toLocaleString()} words from the file? This cannot be undone.`)) return;
  try{
    // Delete all existing docs then add new ones in a batch
    const snapshot = await getDocs(wordsCollection);
    const batch = writeBatch(db);
    snapshot.forEach(docSnap => batch.delete(docSnap.ref));
    parsedSet.forEach(w => batch.set(doc(db,'words',w), {createdAt: serverTimestamp()}));
    await batch.commit();
    // Refresh local set
    await fetchWords();
    alert('Replace completed.');
  }catch(e){ console.error(e); alert('Error during replace. See console.'); }
  // cleanup UI
  fileInput.value=''; fileNameDiv.textContent=''; importConfirm.style.display='none'; importConfirm._parsed=null;
});

/* Append new words only (no duplicates) */
appendBtn.addEventListener('click', async ()=>{
  const parsedSet = importConfirm._parsed; if(!parsedSet) return;
  // Determine how many new words
  const toAdd = [...parsedSet].filter(w=>!words.has(w));
  if(toAdd.length===0){ alert('No new words to add.'); fileInput.value=''; fileNameDiv.textContent=''; importConfirm.style.display='none'; importConfirm._parsed=null; return; }
  if(!confirm(`Append ${toAdd.length.toLocaleString()} new words to Firestore?`)) return;
  try{
    const batch = writeBatch(db);
    toAdd.forEach(w => batch.set(doc(db,'words',w), {createdAt: serverTimestamp()}));
    await batch.commit();
    await fetchWords();
    alert(`Added ${toAdd.length.toLocaleString()} new words.`);
  }catch(e){ console.error(e); alert('Error during append. See console.'); }
  fileInput.value=''; fileNameDiv.textContent=''; importConfirm.style.display='none'; importConfirm._parsed=null;
});

/* Make importExportBox draggable and minimizable */
makeDraggable(importExportBox);
importExportBox.querySelector('.minimizeBtn').addEventListener('click', (e)=>{
  const win = importExportBox; win.style.display='none';
  const minimized = document.createElement('button'); minimized.className='minimized-btn'; minimized.textContent = win.querySelector('.title-bar span').textContent;
  minimized.onclick = ()=>{ win.style.display='block'; minimized.remove(); };
  minimizedContainer.appendChild(minimized);
});

</script>
</body>
</html>
